name: UI Lint - Glass Styles Check

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  glass-styles-check:
    name: Check Glass Styles Usage
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for raw backdrop-blur CSS violations
        run: |
          echo "üîç Checking for raw backdrop-blur CSS usage outside src/platform/ui..."
          echo ""
          echo "Rule: Use Glass* components from @/platform/ui instead of raw backdrop-blur classes."
          echo ""
          
          # Find raw backdrop-blur CSS class usage (not imports)
          # Pattern: backdrop-blur in className or CSS files
          # Excludes: import statements, comments about glass, src/platform/ui/
          
          VIOLATIONS=""
          
          # Check src/ (excluding src/platform/ui/)
          SRC_VIOLATIONS=$(grep -rn --include="*.tsx" --include="*.ts" --include="*.css" \
            -E "backdrop-blur" src/ 2>/dev/null | \
            grep -v "src/platform/ui/" | \
            grep -v "^[^:]*:[^:]*:.*import " | \
            grep -v "^[^:]*:[^:]*:.*\* " | \
            grep -v "^[^:]*:[^:]*:.*// " || true)
          
          # Check app/
          APP_VIOLATIONS=$(grep -rn --include="*.tsx" --include="*.ts" --include="*.css" \
            -E "backdrop-blur" app/ 2>/dev/null | \
            grep -v "^[^:]*:[^:]*:.*import " | \
            grep -v "^[^:]*:[^:]*:.*\* " | \
            grep -v "^[^:]*:[^:]*:.*// " || true)
          
          # Combine violations
          if [ -n "$SRC_VIOLATIONS" ]; then
            VIOLATIONS="$SRC_VIOLATIONS"
          fi
          if [ -n "$APP_VIOLATIONS" ]; then
            if [ -n "$VIOLATIONS" ]; then
              VIOLATIONS="$VIOLATIONS
          $APP_VIOLATIONS"
            else
              VIOLATIONS="$APP_VIOLATIONS"
            fi
          fi
          
          # Check if any violations found
          if [ -n "$VIOLATIONS" ]; then
            echo "‚ùå Raw backdrop-blur CSS violations found!"
            echo ""
            echo "The following files use backdrop-blur CSS classes directly:"
            echo "These styles should only be used via @/platform/ui components."
            echo ""
            echo "$VIOLATIONS"
            echo ""
            echo "üìù To fix:"
            echo "   - Use <GlassSurface> from @/platform/ui for glass backgrounds"
            echo "   - Use <ChromeSurface> for chrome-style glass effects"
            echo "   - Use <DribbbleCard> for card components with glass styling"
            echo "   - Use <GlassHeader> for header components"
            echo ""
            echo "   ‚ùå Bad:  className=\"backdrop-blur-sm bg-white/10\""
            echo "   ‚úÖ Good: <GlassSurface>...</GlassSurface>"
            exit 1
          else
            echo "‚úÖ No raw backdrop-blur CSS violations found!"
            echo "   All glass styles are properly encapsulated in src/platform/ui/"
          fi

      - name: Check for .glass CSS class violations
        run: |
          echo "üîç Checking for raw .glass CSS class usage outside src/platform/ui..."
          echo ""
          
          # Find raw .glass class usage in className attributes
          # Pattern: className containing "glass" but not Glass component imports
          
          VIOLATIONS=""
          
          # Check src/ (excluding src/platform/ui/)
          # Look for className="...glass..." patterns
          SRC_VIOLATIONS=$(grep -rn --include="*.tsx" --include="*.ts" \
            -E 'className="[^"]*\bglass\b[^"]*"' src/ 2>/dev/null | \
            grep -v "src/platform/ui/" || true)
          
          # Check app/
          APP_VIOLATIONS=$(grep -rn --include="*.tsx" --include="*.ts" \
            -E 'className="[^"]*\bglass\b[^"]*"' app/ 2>/dev/null || true)
          
          # Also check template literals with glass class
          SRC_VIOLATIONS2=$(grep -rn --include="*.tsx" --include="*.ts" \
            -E 'className=\{?`[^`]*\bglass\b[^`]*`' src/ 2>/dev/null | \
            grep -v "src/platform/ui/" || true)
          
          APP_VIOLATIONS2=$(grep -rn --include="*.tsx" --include="*.ts" \
            -E 'className=\{?`[^`]*\bglass\b[^`]*`' app/ 2>/dev/null || true)
          
          # Combine all violations
          for V in "$SRC_VIOLATIONS" "$APP_VIOLATIONS" "$SRC_VIOLATIONS2" "$APP_VIOLATIONS2"; do
            if [ -n "$V" ]; then
              if [ -n "$VIOLATIONS" ]; then
                VIOLATIONS="$VIOLATIONS
          $V"
              else
                VIOLATIONS="$V"
              fi
            fi
          done
          
          # Check if any violations found
          if [ -n "$VIOLATIONS" ]; then
            echo "‚ùå Raw .glass CSS class violations found!"
            echo ""
            echo "The following files use the .glass CSS class directly:"
            echo "These styles should only be used via @/platform/ui components."
            echo ""
            echo "$VIOLATIONS"
            echo ""
            echo "üìù To fix:"
            echo "   - Use <GlassSurface> from @/platform/ui instead of className=\"glass\""
            echo "   - Use <ChromeSurface> for chrome-style surfaces"
            echo ""
            echo "   ‚ùå Bad:  <div className=\"glass\">...</div>"
            echo "   ‚úÖ Good: <GlassSurface>...</GlassSurface>"
            exit 1
          else
            echo "‚úÖ No raw .glass CSS class violations found!"
          fi
